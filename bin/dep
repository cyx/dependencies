#! /usr/bin/env ruby

require "fileutils"
require "dependencies/dep"
require "thor"

class App < Thor
  def list(env = nil)
    deps.filter(env).each { |dep| puts dep }
    deps.require(env)
  end

  def vendor(name)
    dep = dependency(name)  || flunk("Dependency #{name} not found in dependencies.")
    dep.url                 || flunk("Don't know where to vendor #{name} from (no URL given...)")

    FileUtils.mkdir("vendor") unless File.directory?("vendor")

    Dir.chdir("vendor") do
      system "git clone #{dep.url} #{dep.name} -q"
      Dir.chdir(dep.name) { FileUtils.rm_rf(".git") }
    end
  end

protected

  def deps
    @deps ||= Dep.new(File.read("dependencies"))
  end

  def dependency(name)
    deps.find { |dep| dep.name == name }
  end

  def flunk(message)
    $stderr.puts(message)
    exit 1
  end
end

App.start
